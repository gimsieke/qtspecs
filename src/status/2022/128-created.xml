<item>
   <title>Issue #128 created</title>
   <pubDate>2022-08-17T10:29:05Z</pubDate>
   <link>https://github.com/qt4cg/qtspecs/issues/128</link>
   <guid>https://qt4cg.org/@qt4cg/2022/#created-128</guid>
   <description>&lt;div&gt;&lt;p&gt;fn:replace: Tweaks&lt;/p&gt;&lt;div class="markup"&gt;&lt;p&gt;Some suggestions for &lt;code&gt;fn:replace&lt;/code&gt;:&lt;/p&gt;
&lt;h4&gt;A. Simplify/unify retrieval of the replacement value&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;If &lt;code&gt;$action&lt;/code&gt; is present, call the function.&lt;/li&gt;
&lt;li&gt;If &lt;code&gt;$replacement&lt;/code&gt; is present, obtain its value.&lt;/li&gt;
&lt;li&gt;If no argument is present, use the empty sequence.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See https://github.com/qt4cg/qtspecs/issues/104#issuecomment-1210506639 for similar replacements in maps and arrays.&lt;/p&gt;
&lt;h4&gt;B. Simplify actions by relaxing types:&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Pass on matches as &lt;code&gt;xs:untypedAtomic&lt;/code&gt; items.&lt;/li&gt;
&lt;li&gt;Apply &lt;code&gt;fn:string&lt;/code&gt; to the result of the action (or even &lt;code&gt;fn:string-join&lt;/code&gt;, if we allow sequences as return values).&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;C. Always use &lt;code&gt;xs:string?&lt;/code&gt; for &lt;code&gt;$flags&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;…affects &lt;code&gt;fn:matches&lt;/code&gt;, &lt;code&gt;fn:tokenize&lt;/code&gt;, and &lt;code&gt;fn:analyze-string&lt;/code&gt;.&lt;/p&gt;
&lt;h4&gt;Resulting function signature&lt;/h4&gt;
&lt;pre&gt;&lt;code class="language-xquery"&gt;fn:replace(
  $value        as xs:string?,
  $pattern      as xs:string,
  $replacement  as xs:string?                                                  := '',
  $flags        as xs:string?                                                  := '',
  $action       as (function(xs:untypedAtomic, xs:untypedAtomic*) as item()?)? := ()
) as xs:string
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;Examples&lt;/h4&gt;
&lt;p&gt;…taken from the &lt;a href="https://qt4cg.org/branch/master/xpath-functions-40/Overview-diff.html#func-replace"&gt;specification draft&lt;/a&gt; and simplified/fixed:&lt;/p&gt;
&lt;pre&gt;&lt;code class="language-xquery"&gt;fn:replace("Chapter 9", "[0-9]+", action := function { . + 1 }),

fn:replace(
  "57°43′30″",
  "([0-9]+)°([0-9]+)′([0-9]+)″",
  action := function($matches) {
    ($matches[1] + $matches[2] div 60 + $matches[3] div 3600) || '°'
  }
)
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
</item>
